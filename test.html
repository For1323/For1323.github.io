<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Interactive Solar System 3D Model</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            overflow: hidden;
            color: white;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.4s ease;
        }

        #controls.hidden {
            transform: translateX(-100%);
            opacity: 0;
        }

        #toggleControlsBtn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 101;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0);
        }

        #toggleControlsBtn.visible {
            opacity: 1;
            transform: scale(1);
        }

        #toggleControlsBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #a0a0ff;
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn.active {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 3px 10px rgba(245, 87, 108, 0.4);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn.success {
            background: linear-gradient(45deg, #51cf66 0%, #40c057 100%);
        }

        .btn.education {
            background: linear-gradient(45deg, #ffd43b 0%, #fab005 100%);
        }

        .speed-control {
            width: 100%;
        }

        .speed-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            outline: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .speed-slider:hover {
            opacity: 1;
        }

        .speed-value {
            text-align: center;
            margin-top: 8px;
            color: #ffffff;
            font-weight: bold;
            font-size: 12px;
        }

        .time-control {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 12px;
            color: #ffffff;
            cursor: pointer;
        }

        .hide-controls-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .hide-controls-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #planetInfo {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 350px;
            transform: translateX(400px);
            transition: transform 0.4s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        #planetInfo.visible {
            transform: translateX(0);
        }

        .planet-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .planet-english {
            font-size: 14px;
            color: #a0a0ff;
            margin-bottom: 20px;
            font-style: italic;
        }

        .planet-data {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .planet-data:last-child {
            border-bottom: none;
        }

        .data-label {
            color: #a0a0ff;
            font-weight: bold;
            font-size: 14px;
        }

        .data-value {
            color: white;
            font-weight: normal;
            text-align: right;
            font-size: 14px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #title {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            color: white;
        }

        .main-title {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: #a0a0ff;
            opacity: 0.8;
        }

        .scale-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a0a0ff;
            font-size: 12px;
            max-width: 280px;
        }

        .fps-display {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 700;
            color: #00ff41;
            text-shadow: 0 0 20px #00ff41, 0 0 40px #00ff41;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid rgba(0, 255, 65, 0.3);
            backdrop-filter: blur(10px);
            letter-spacing: 2px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
            color: white;
            font-size: 18px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-panel {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            width: 280px;
            display: none;
        }

        .stats-panel.visible {
            display: block;
        }

        .education-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .education-panel.visible {
            display: block;
        }

        .education-title {
            font-size: 24px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ffd43b, #fab005);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .quiz-container {
            margin-bottom: 30px;
        }

        .question {
            font-size: 18px;
            color: white;
            margin-bottom: 15px;
        }

        .answers {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .answer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .answer-btn.correct {
            background: linear-gradient(45deg, #51cf66, #40c057);
        }

        .answer-btn.incorrect {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .score-display {
            text-align: center;
            font-size: 18px;
            color: #ffd43b;
            margin-bottom: 20px;
        }

        .help-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .help-panel.visible {
            display: block;
        }

        .help-title {
            font-size: 20px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section h3 {
            color: #a0a0ff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .help-section p {
            color: white;
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>正在构建太阳系...</p>
        </div>

        <button id="toggleControlsBtn" class="visible" onclick="toggleControls()">☰</button>

        <div id="controls">
            <button class="hide-controls-btn" onclick="hideControls()">−</button>
            
            <div class="control-group">
                <label class="control-label">视角切换</label>
                <div class="button-group">
                    <button class="btn active" onclick="setCamera('overview')">全景</button>
                    <button class="btn" onclick="setCamera('side')">侧视</button>
                    <button class="btn" onclick="setCamera('orrery')">太阳系仪</button>
                    <button class="btn" onclick="setCamera('follow')">跟随地球</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">公转速度</label>
                <div class="speed-control">
                    <input type="range" class="speed-slider" min="0" max="10" step="0.5" value="1" id="speedSlider">
                    <div class="speed-value" id="speedValue">1.0x</div>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">时间方向</label>
                <div class="time-control">
                    <button class="btn active" onclick="setTimeDirection(1)" id="forwardBtn">正转</button>
                    <button class="btn" onclick="setTimeDirection(-1)" id="reverseBtn">反转</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">显示模式</label>
                <div class="button-group">
                    <button class="btn active" onclick="setScaleMode('mixed')" id="scaleMixedBtn">平衡模式</button>
                    <button class="btn" onclick="setScaleMode('distance')" id="scaleDistanceBtn">距离比例</button>
                    <button class="btn" onclick="setScaleMode('size')" id="scaleSizeBtn">大小比例</button>
                    <button class="btn" onclick="setScaleMode('realistic')" id="scaleRealisticBtn">真实比例</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">显示选项</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showOrbits" checked onchange="toggleOrbits()">
                        <label for="showOrbits">轨道线</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showAsteroids" checked onchange="toggleAsteroids()">
                        <label for="showAsteroids">小行星带</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showComets" checked onchange="toggleComets()">
                        <label for="showComets">彗星</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showTrails" onchange="toggleTrails()">
                        <label for="showTrails">轨迹</label>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">功能</label>
                <div class="button-group">
                    <button class="btn education" onclick="toggleEducation()">天文问答</button>
                    <button class="btn" onclick="toggleStats()">统计面板</button>
                    <button class="btn success" onclick="resetCamera()">重置视角</button>
                    <button class="btn" onclick="toggleHelp()">帮助</button>
                    <button class="btn danger" onclick="pauseResume()">暂停</button>
                </div>
            </div>
        </div>

        <div id="planetInfo">
            <button class="close-btn" onclick="closePlanetInfo()">×</button>
            <div class="planet-name" id="planetName"></div>
            <div class="planet-english" id="planetEnglish"></div>
            <div id="planetData"></div>
        </div>

        <div class="stats-panel" id="statsPanel">
            <h3 style="color: #a0a0ff; margin-bottom: 15px;">实时统计</h3>
            <div id="statsContent"></div>
        </div>

        <div class="education-panel" id="educationPanel">
            <button class="close-btn" onclick="toggleEducation()">×</button>
            <h2 class="education-title">🌟 天文知识问答</h2>
            <div class="score-display" id="scoreDisplay">得分: <span id="score">0</span> / <span id="totalQuestions">0</span></div>
            <div class="quiz-container" id="quizContainer">
                <!-- 问题将动态加载 -->
            </div>
            <div class="button-group" style="justify-content: center; margin-top: 20px;">
                <button class="btn education" onclick="nextQuestion()">下一题</button>
                <button class="btn" onclick="resetQuiz()">重新开始</button>
            </div>
        </div>

        <div class="help-panel" id="helpPanel">
            <button class="close-btn" onclick="toggleHelp()">×</button>
            <h2 class="help-title">太阳系3D模型 - 使用指南</h2>
            
            <div class="help-section">
                <h3>🎮 基础操作</h3>
                <p>• 鼠标拖拽：旋转视角</p>
                <p>• 鼠标滚轮：缩放视距</p>
                <p>• 点击天体：查看详细信息</p>
                <p>• 双击行星：聚焦跟随模式</p>
            </div>

            <div class="help-section">
                <h3>📐 显示模式说明</h3>
                <p>• 平衡模式：教学友好，距离和大小都适中</p>
                <p>• 距离比例：真实距离比例，行星大小放大</p>
                <p>• 大小比例：真实大小比例，距离压缩</p>
                <p>• 真实比例：完全真实比例（行星极小）</p>
            </div>

            <div class="help-section">
                <h3>⏰ 时间控制</h3>
                <p>• 正转：正常时间方向运行</p>
                <p>• 反转：时间倒流，行星逆向运动</p>
                <p>• 速度滑块：控制公转速度（0-10倍）</p>
            </div>

            <div class="help-section">
                <h3>🎓 教育功能</h3>
                <p>• 天文问答：测试你的天文知识</p>
                <p>• 详细信息：点击任意天体查看科学数据</p>
                <p>• 真实比例：体验宇宙的真实尺度</p>
            </div>
        </div>

        <div id="title">
            <h1 class="main-title">增强版太阳系 3D 模型</h1>
            <p class="subtitle">探索宇宙奥秘 • 双击行星跟随 • 天文知识问答 • F键全屏</p>
        </div>

        <div class="scale-info" id="scaleInfo">
            当前模式：平衡模式<br>
            适合教学和观察的最佳平衡
        </div>

        <div class="fps-display" id="fpsDisplay">60 FPS</div>
    </div>

    <script>
        // 全局变量
        let scene, camera, renderer, controls;
        let planets = [];
        let orbits = [];
        let asteroids = [];
        let comets = [];
        let sun;
        let speedMultiplier = 1;
        let timeDirection = 1;
        let currentCameraMode = 'overview';
        let scaleMode = 'mixed';
        let animationId;
        let starField;
        let focusedPlanet = null;
        let isPaused = false;
        let showTrails = false;
        let trailPoints = {};
        let lastTime = 0;
        let frameCount = 0;
        let fps = 60;
        let cameraTarget = new THREE.Vector3();
        let cameraPosition = new THREE.Vector3();
        let smoothFactor = 0.05;

        // 教育问答系统
        let currentQuestionIndex = 0;
        let score = 0;
        let totalAnswered = 0;
        let answeredQuestions = [];

        const quizQuestions = [
            {
                question: "哪个行星是太阳系中最大的行星？",
                answers: ["地球", "木星", "土星", "海王星"],
                correct: 1,
                explanation: "木星是太阳系中最大的行星，质量超过所有其他行星的总和。"
            },
            {
                question: "哪个行星被称为'红色星球'？",
                answers: ["金星", "火星", "木星", "土星"],
                correct: 1,
                explanation: "火星因其表面富含氧化铁而呈现红色，因此被称为红色星球。"
            },
            {
                question: "土星最著名的特征是什么？",
                answers: ["巨大的风暴", "美丽的光环", "最多的卫星", "最快的自转"],
                correct: 1,
                explanation: "土星以其美丽壮观的行星环系统而著名，这些环由冰和岩石颗粒组成。"
            },
            {
                question: "距离太阳最近的行星是哪个？",
                answers: ["水星", "金星", "地球", "火星"],
                correct: 0,
                explanation: "水星是距离太阳最近的行星，公转周期仅88天。"
            },
            {
                question: "哪个行星的一天最长？",
                answers: ["水星", "金星", "地球", "木星"],
                correct: 1,
                explanation: "金星的自转周期为243地球日，比它的公转周期还要长。"
            },
            {
                question: "太阳系中最冷的行星是哪个？",
                answers: ["天王星", "海王星", "冥王星", "土星"],
                correct: 0,
                explanation: "虽然海王星距离太阳更远，但天王星因其独特的倾斜角度，是最冷的行星。"
            },
            {
                question: "小行星带位于哪两个行星之间？",
                answers: ["地球和火星", "火星和木星", "木星和土星", "土星和天王星"],
                correct: 1,
                explanation: "小行星带位于火星和木星之间，包含数十万颗小行星。"
            },
            {
                question: "哈雷彗星多少年回归一次？",
                answers: ["50年", "76年", "100年", "120年"],
                correct: 1,
                explanation: "哈雷彗星的公转周期约为76年，上次回归是1986年。"
            }
        ];
        
        // 增强的行星数据，包含纹理信息
        const planetData = {
            mercury: {
                name: '水星', english: 'Mercury',
                realRadius: 0.38, realDistance: 10, speed: 0.024, 
                color: 0x8c7853, craterIntensity: 0.8,
                diameter: '4,879 km', avgDistance: '5,790万 km', 
                orbitalPeriod: '88天', rotationPeriod: '59天', type: '岩石行星',
                mass: '3.3 × 10²³ kg', gravity: '3.7 m/s²', temperature: '-173~427°C',
                description: '太阳系最小的行星，表面布满陨石坑，温差极大。'
            },
            venus: {
                name: '金星', english: 'Venus',
                realRadius: 0.95, realDistance: 15, speed: 0.018, 
                color: 0xffc649, cloudIntensity: 0.9,
                diameter: '12,104 km', avgDistance: '1.08亿 km',
                orbitalPeriod: '225天', rotationPeriod: '243天', type: '岩石行星',
                mass: '4.87 × 10²⁴ kg', gravity: '8.87 m/s²', temperature: '462°C',
                description: '被厚厚的云层覆盖，是太阳系中最热的行星。'
            },
            earth: {
                name: '地球', english: 'Earth',
                realRadius: 1, realDistance: 20, speed: 0.015, 
                color: 0x6b93d6, oceanIntensity: 0.7, landIntensity: 0.3,
                diameter: '12,756 km', avgDistance: '1.5亿 km',
                orbitalPeriod: '365天', rotationPeriod: '24小时', type: '岩石行星',
                mass: '5.97 × 10²⁴ kg', gravity: '9.8 m/s²', temperature: '-89~58°C',
                description: '太阳系中唯一已知存在生命的行星，被称为蓝色星球。'
            },
            mars: {
                name: '火星', english: 'Mars',
                realRadius: 0.53, realDistance: 25, speed: 0.012, 
                color: 0xc1440e, craterIntensity: 0.6, dustIntensity: 0.8,
                diameter: '6,792 km', avgDistance: '2.28亿 km',
                orbitalPeriod: '687天', rotationPeriod: '24.6小时', type: '岩石行星',
                mass: '6.42 × 10²³ kg', gravity: '3.71 m/s²', temperature: '-87~-5°C',
                description: '红色星球，表面有巨大的峡谷和火山，可能曾经有水。'
            },
            jupiter: {
                name: '木星', english: 'Jupiter',
                realRadius: 3, realDistance: 40, speed: 0.006, 
                color: 0xd8ca9d, bandIntensity: 0.9, stormIntensity: 0.7,
                diameter: '142,984 km', avgDistance: '7.79亿 km',
                orbitalPeriod: '12年', rotationPeriod: '9.9小时', type: '气态巨星',
                mass: '1.90 × 10²⁷ kg', gravity: '24.79 m/s²', temperature: '-108°C',
                description: '太阳系最大的行星，拥有著名的大红斑风暴和众多卫星。'
            },
            saturn: {
                name: '土星', english: 'Saturn',
                realRadius: 2.5, realDistance: 55, speed: 0.004, 
                color: 0xfad5a5, ringIntensity: 1.0,
                diameter: '120,536 km', avgDistance: '14.3亿 km',
                orbitalPeriod: '29年', rotationPeriod: '10.7小时', type: '气态巨星',
                mass: '5.68 × 10²⁶ kg', gravity: '10.44 m/s²', temperature: '-139°C',
                description: '拥有壮观光环系统的美丽行星，密度比水还小。'
            },
            uranus: {
                name: '天王星', english: 'Uranus',
                realRadius: 1.5, realDistance: 70, speed: 0.003, 
                color: 0x4fd0e7, iceIntensity: 0.8,
                diameter: '51,118 km', avgDistance: '28.7亿 km',
                orbitalPeriod: '84年', rotationPeriod: '17.2小时', type: '冰巨星',
                mass: '8.68 × 10²⁵ kg', gravity: '8.69 m/s²', temperature: '-197°C',
                description: '侧躺着公转的冰巨星，拥有微弱的光环系统。'
            },
            neptune: {
                name: '海王星', english: 'Neptune',
                realRadius: 1.4, realDistance: 85, speed: 0.002, 
                color: 0x4b70dd, windIntensity: 0.9,
                diameter: '49,528 km', avgDistance: '45.0亿 km',
                orbitalPeriod: '165年', rotationPeriod: '16.1小时', type: '冰巨星',
                mass: '1.02 × 10²⁶ kg', gravity: '11.15 m/s²', temperature: '-201°C',
                description: '太阳系最远的行星，拥有最强烈的风暴，风速可达2100公里/小时。'
            }
        };

        // 彗星数据
        const cometData = [
            {
                name: '哈雷彗星', english: 'Halley\'s Comet',
                perihelion: 15, aphelion: 80, speed: 0.008, color: 0x88ccff,
                orbitalPeriod: '76年', type: '周期彗星'
            },
            {
                name: '恩克彗星', english: 'Encke\'s Comet',
                perihelion: 8, aphelion: 35, speed: 0.015, color: 0xaaffcc,
                orbitalPeriod: '3.3年', type: '短周期彗星'
            }
        ];

        // 初始化场景
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
            camera.position.set(0, 80, 120);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);

            createStarField();
            createSun();
            createPlanets();
            createAsteroidBelt();
            createComets();
            setupLighting();
            setupControls();
            setupEventListeners();
            initTrailTracking();
            initEducationSystem();

            document.getElementById('loading').style.display = 'none';
            animate();
        }

        // 创建增强的星空背景
        function createStarField() {
            const geometry = new THREE.SphereGeometry(1500, 64, 64);
            const material = new THREE.MeshBasicMaterial({
                color: 0x000022,
                side: THREE.BackSide
            });
            starField = new THREE.Mesh(geometry, material);
            
            // 创建多层星点效果
            for (let layer = 0; layer < 3; layer++) {
                const starGeometry = new THREE.BufferGeometry();
                const starCount = 5000 + layer * 2000;
                const starVertices = [];
                const starColors = [];
                
                for (let i = 0; i < starCount; i++) {
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(Math.random() * 2 - 1);
                    const r = 1200 + Math.random() * 300 + layer * 100;
                    
                    starVertices.push(
                        r * Math.sin(phi) * Math.cos(theta),
                        r * Math.sin(phi) * Math.sin(theta),
                        r * Math.cos(phi)
                    );
                    
                    // 不同颜色的星星
                    const starType = Math.random();
                    if (starType < 0.7) {
                        starColors.push(1, 1, 1); // 白色
                    } else if (starType < 0.9) {
                        starColors.push(1, 0.8, 0.6); // 黄色
                    } else {
                        starColors.push(0.8, 0.8, 1); // 蓝色
                    }
                }

                starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
                starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));
                
                const starMaterial = new THREE.PointsMaterial({
                    vertexColors: true,
                    size: 1 + layer * 0.5,
                    sizeAttenuation: false
                });

                const stars = new THREE.Points(starGeometry, starMaterial);
                scene.add(stars);
            }
            
            scene.add(starField);
        }

        // 创建增强的太阳
        function createSun() {
            const sunGeometry = new THREE.SphereGeometry(5, 64, 64);
            
            // 创建太阳表面纹理效果
            const sunMaterial = new THREE.MeshBasicMaterial({
                color: 0xffff00,
                emissive: 0xff6600,
                emissiveIntensity: 0.6
            });
            
            sun = new THREE.Mesh(sunGeometry, sunMaterial);
            sun.castShadow = false;
            sun.userData = { 
                name: '太阳', 
                english: 'Sun',
                diameter: '1,392,700 km',
                avgDistance: '0 km',
                orbitalPeriod: '不适用',
                rotationPeriod: '25天',
                type: '恒星',
                mass: '1.99 × 10³⁰ kg',
                temperature: '5,778K (表面)',
                description: '太阳系的中心恒星，为所有行星提供光和热。'
            };
            
            // 添加太阳光晕效果
            const coronaGeometry = new THREE.SphereGeometry(7, 32, 32);
            const coronaMaterial = new THREE.MeshBasicMaterial({
                color: 0xff8800,
                transparent: true,
                opacity: 0.1,
                side: THREE.BackSide
            });
            const corona = new THREE.Mesh(coronaGeometry, coronaMaterial);
            sun.add(corona);
            
            scene.add(sun);
        }

        // 创建增强的行星系统
        function createPlanets() {
            const planetKeys = Object.keys(planetData);
            
            planetKeys.forEach((key, index) => {
                const data = planetData[key];
                
                // 创建精确的轨道
                const orbitGeometry = new THREE.RingGeometry(data.realDistance - 0.1, data.realDistance + 0.1, 256);
                const orbitMaterial = new THREE.MeshBasicMaterial({
                    color: 0x444444,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.2
                });
                const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                orbit.rotation.x = -Math.PI / 2;
                orbit.userData = { type: 'orbit', planetKey: key };
                scene.add(orbit);
                orbits.push(orbit);

                // 创建增强的行星
                const planet = createDetailedPlanet(data, key);
                scene.add(planet);
                planets.push(planet);
            });
        }

        // 创建详细的行星
        function createDetailedPlanet(data, key) {
            const planetGeometry = new THREE.SphereGeometry(data.realRadius, 64, 64);
            
            // 根据行星特点创建不同的材质
            let planetMaterial;
            
            if (key === 'earth') {
                // 地球：海洋和陆地
                planetMaterial = new THREE.MeshLambertMaterial({ 
                    color: data.color,
                    transparent: true,
                    opacity: 0.9
                });
                
                // 添加大气层效果
                const atmosphereGeometry = new THREE.SphereGeometry(data.realRadius * 1.05, 32, 32);
                const atmosphereMaterial = new THREE.MeshBasicMaterial({
                    color: 0x87ceeb,
                    transparent: true,
                    opacity: 0.1,
                    side: THREE.BackSide
                });
                const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
                
            } else if (key === 'jupiter' || key === 'saturn') {
                // 气态巨星：带状结构
                planetMaterial = new THREE.MeshLambertMaterial({ 
                    color: data.color
                });
                
            } else if (key === 'mars') {
                // 火星：表面细节
                planetMaterial = new THREE.MeshLambertMaterial({ 
                    color: data.color,
                    roughness: 0.9
                });
                
            } else {
                // 其他行星
                planetMaterial = new THREE.MeshLambertMaterial({ 
                    color: data.color,
                    roughness: 0.7
                });
            }
            
            const planet = new THREE.Mesh(planetGeometry, planetMaterial);
            
            // 精确定位在轨道上
            planet.position.x = data.realDistance;
            planet.position.y = 0;
            planet.position.z = 0;
            
            planet.castShadow = true;
            planet.receiveShadow = true;
            
            planet.userData = {
                ...data,
                key: key,
                angle: Math.random() * Math.PI * 2,
                originalRadius: data.realRadius,
                originalDistance: data.realDistance,
                basePosition: new THREE.Vector3(data.realDistance, 0, 0)
            };
            
            // 特殊处理
            if (key === 'saturn') {
                addSaturnRings(planet, data);
            } else if (key === 'earth') {
                // 如果有大气层，添加到场景
                if (typeof atmosphere !== 'undefined') {
                    planet.add(atmosphere);
                }
            }
            
            return planet;
        }

        // 添加土星光环
        function addSaturnRings(planet, data) {
            const ringGeometry = new THREE.RingGeometry(data.realRadius * 1.2, data.realRadius * 2.2, 128);
            const ringMaterial = new THREE.MeshBasicMaterial({
                color: 0xccccaa,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.8
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.x = -Math.PI / 2;
            ring.rotation.z = Math.PI / 12; // 倾斜
            planet.add(ring);
        }

        // 添加地球月球
        function addEarthMoon(planet) {
            const moonGeometry = new THREE.SphereGeometry(0.27, 32, 32);
            const moonMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x888888,
                roughness: 1.0
            });
            const moon = new THREE.Mesh(moonGeometry, moonMaterial);
            moon.position.set(3.84, 0, 0); // 真实比例距离
            moon.castShadow = true;
            moon.receiveShadow = true;
            moon.userData = {
                name: '月球', english: 'Moon', type: '天然卫星',
                angle: 0, speed: 0.05,
                diameter: '3,474 km',
                avgDistance: '384,400 km',
                orbitalPeriod: '27.3天',
                description: '地球唯一的天然卫星，影响地球的潮汐。'
            };
            planet.add(moon);
        }

        // 创建小行星带
        function createAsteroidBelt() {
            const asteroidCount = 1000;
            const minDistance = 30;
            const maxDistance = 38;

            for (let i = 0; i < asteroidCount; i++) {
                const distance = minDistance + Math.random() * (maxDistance - minDistance);
                const initialAngle = Math.random() * Math.PI * 2;
                const size = 0.02 + Math.random() * 0.1;

                // 随机形状的小行星
                const asteroidGeometry = new THREE.SphereGeometry(size, 6, 6);
                
                // 随机变形
                const positions = asteroidGeometry.attributes.position.array;
                for (let j = 0; j < positions.length; j += 3) {
                    positions[j] *= 0.7 + Math.random() * 0.6;
                    positions[j + 1] *= 0.7 + Math.random() * 0.6;
                    positions[j + 2] *= 0.7 + Math.random() * 0.6;
                }
                asteroidGeometry.attributes.position.needsUpdate = true;
                asteroidGeometry.computeVertexNormals();
                
                const asteroidMaterial = new THREE.MeshLambertMaterial({ 
                    color: new THREE.Color().setHSL(0.1, 0.2, 0.1 + Math.random() * 0.3)
                });
                
                const asteroid = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
                const asteroidPosX = Math.cos(initialAngle) * distance;
                const asteroidPosZ = Math.sin(initialAngle) * distance;
                const asteroidPosY = (Math.random() - 0.5) * 1;
                asteroid.position.set(asteroidPosX, asteroidPosY, asteroidPosZ);
                
                asteroid.castShadow = true;
                
                asteroid.userData = {
                    type: 'asteroid',
                    distance: distance,
                    angle: initialAngle,
                    speed: 0.0005 + Math.random() * 0.001,
                    rotationSpeed: (Math.random() - 0.5) * 0.02,
                    name: `小行星 ${i + 1}`,
                    description: '小行星带中的岩石碎片，可能是行星形成时的残留物。'
                };
                
                scene.add(asteroid);
                asteroids.push(asteroid);
            }
        }

        // 创建彗星
        function createComets() {
            cometData.forEach((data, index) => {
                const cometGeometry = new THREE.SphereGeometry(0.2, 16, 16);
                const cometMaterial = new THREE.MeshLambertMaterial({ 
                    color: data.color,
                    emissive: data.color,
                    emissiveIntensity: 0.3
                });
                
                const comet = new THREE.Mesh(cometGeometry, cometMaterial);
                comet.position.x = data.perihelion;
                comet.castShadow = true;
                
                // 创建彗尾
                const tailGeometry = new THREE.ConeGeometry(0.3, 6, 12);
                const tailMaterial = new THREE.MeshBasicMaterial({
                    color: data.color,
                    transparent: true,
                    opacity: 0.4
                });
                const tail = new THREE.Mesh(tailGeometry, tailMaterial);
                tail.rotation.z = Math.PI / 2;
                tail.position.x = -3;
                comet.add(tail);

                comet.userData = {
                    ...data,
                    type: 'comet',
                    angle: Math.random() * Math.PI * 2,
                    currentDistance: data.perihelion
                };
                
                scene.add(comet);
                comets.push(comet);
            });
        }

        // 设置光照
        function setupLighting() {
            const ambientLight = new THREE.AmbientLight(0x404040, 0.2);
            scene.add(ambientLight);

            const sunLight = new THREE.PointLight(0xffffff, 2, 2000);
            sunLight.position.set(0, 0, 0);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 4096;
            sunLight.shadow.mapSize.height = 4096;
            sunLight.shadow.camera.far = 2000;
            scene.add(sunLight);
        }

        // 初始化轨迹追踪
        function initTrailTracking() {
            planets.forEach(planet => {
                trailPoints[planet.userData.key] = [];
            });
        }

        // 初始化教育系统
        function initEducationSystem() {
            shuffleArray(quizQuestions);
            loadQuestion();
        }

        // 打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 加载问题
        function loadQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                currentQuestionIndex = 0;
                shuffleArray(quizQuestions);
            }
            
            const question = quizQuestions[currentQuestionIndex];
            if (answeredQuestions.includes(currentQuestionIndex)) {
                currentQuestionIndex++;
                loadQuestion();
                return;
            }
            
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="question">Q${totalAnswered + 1}: ${question.question}</div>
                <div class="answers">
                    ${question.answers.map((answer, index) => 
                        `<button class="answer-btn" onclick="selectAnswer(${index})">${String.fromCharCode(65 + index)}. ${answer}</button>`
                    ).join('')}
                </div>
                <div id="explanation" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                    <strong>解释：</strong><span id="explanationText"></span>
                </div>
            `;
        }

        // 选择答案
        function selectAnswer(selectedIndex) {
            const question = quizQuestions[currentQuestionIndex];
            const buttons = document.querySelectorAll('.answer-btn');
            const explanation = document.getElementById('explanation');
            const explanationText = document.getElementById('explanationText');
            
            buttons.forEach((btn, index) => {
                btn.disabled = true;
                if (index === question.correct) {
                    btn.classList.add('correct');
                } else if (index === selectedIndex && selectedIndex !== question.correct) {
                    btn.classList.add('incorrect');
                }
            });
            
            if (selectedIndex === question.correct) {
                score++;
            }
            
            totalAnswered++;
            answeredQuestions.push(currentQuestionIndex);
            
            explanationText.textContent = question.explanation;
            explanation.style.display = 'block';
            
            updateScore();
        }

        // 更新分数显示
        function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('totalQuestions').textContent = totalAnswered;
        }

        // 下一题
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        // 重置问答
        function resetQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            totalAnswered = 0;
            answeredQuestions = [];
            shuffleArray(quizQuestions);
            updateScore();
            loadQuestion();
        }

        // 控制面板切换
        function toggleControls() {
            const controls = document.getElementById('controls');
            const toggleBtn = document.getElementById('toggleControlsBtn');
            
            controls.classList.remove('hidden');
            toggleBtn.classList.remove('visible');
        }

        function hideControls() {
            const controls = document.getElementById('controls');
            const toggleBtn = document.getElementById('toggleControlsBtn');
            
            controls.classList.add('hidden');
            setTimeout(() => {
                toggleBtn.classList.add('visible');
            }, 200);
        }

        // 优化的相机跟踪系统
        function updateFollowCamera() {
            if (currentCameraMode === 'follow' && focusedPlanet) {
                const targetPosition = focusedPlanet.position.clone();
                const offset = new THREE.Vector3(
                    focusedPlanet.userData.radius * 8,
                    focusedPlanet.userData.radius * 4,
                    focusedPlanet.userData.radius * 8
                );
                
                targetPosition.add(offset);
                
                // 平滑相机移动
                camera.position.lerp(targetPosition, smoothFactor);
                
                // 平滑相机朝向
                cameraTarget.copy(focusedPlanet.position);
                camera.lookAt(cameraTarget);
            }
        }

        // 设置控制器
        function setupControls() {
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;

            renderer.domElement.addEventListener('mousedown', (event) => {
                mouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            renderer.domElement.addEventListener('mouseup', () => {
                mouseDown = false;
            });

            renderer.domElement.addEventListener('mousemove', (event) => {
                if (!mouseDown) return;

                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;

                if (currentCameraMode !== 'follow') {
                    const spherical = new THREE.Spherical();
                    spherical.setFromVector3(camera.position);
                    
                    spherical.theta -= deltaX * 0.008;
                    spherical.phi += deltaY * 0.008;
                    spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));

                    camera.position.setFromSpherical(spherical);
                    camera.lookAt(0, 0, 0);
                }

                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            renderer.domElement.addEventListener('wheel', (event) => {
                if (currentCameraMode !== 'follow') {
                    const distance = camera.position.length();
                    const newDistance = distance + event.deltaY * 0.3;
                    
                    if (newDistance > 15 && newDistance < 1000) {
                        camera.position.normalize();
                        camera.position.multiplyScalar(newDistance);
                    }
                }
            });

            renderer.domElement.addEventListener('dblclick', onPlanetDoubleClick);
        }

        // 设置事件监听
        function setupEventListeners() {
            const speedSlider = document.getElementById('speedSlider');
            speedSlider.addEventListener('input', (e) => {
                speedMultiplier = parseFloat(e.target.value);
                document.getElementById('speedValue').textContent = speedMultiplier.toFixed(1) + 'x';
            });

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            renderer.domElement.addEventListener('click', onPlanetClick);
            window.addEventListener('keydown', onKeyDown);
        }

        // 键盘事件处理
        function onKeyDown(event) {
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    pauseResume();
                    break;
                case 'KeyF':
                    toggleFullscreen();
                    break;
                case 'KeyR':
                    resetCamera();
                    break;
                case 'KeyH':
                    toggleHelp();
                    break;
                case 'KeyS':
                    toggleStats();
                    break;
                case 'KeyE':
                    toggleEducation();
                    break;
            }
        }

        // 行星点击事件
        function onPlanetClick(event) {
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            const allObjects = [sun, ...planets, ...asteroids.slice(0, 50), ...comets];
            const intersects = raycaster.intersectObjects(allObjects, true);
            
            if (intersects.length > 0) {
                let clickedObject = intersects[0].object;
                
                // 如果点击的是子对象（如月球），获取其数据
                if (clickedObject.parent && clickedObject.parent.userData && clickedObject.parent.userData.key) {
                    showPlanetInfo(clickedObject.userData);
                } else {
                    showPlanetInfo(clickedObject.userData);
                }
            }
        }

        // 双击聚焦事件
        function onPlanetDoubleClick(event) {
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(planets);
            
            if (intersects.length > 0) {
                focusedPlanet = intersects[0].object;
                setCamera('follow');
            }
        }

        // 修正行星位置，确保在轨道上
        function updatePlanetPositions() {
            planets.forEach(planet => {
                const data = planet.userData;
                
                // 精确的轨道运动
                data.angle += data.speed * speedMultiplier * timeDirection;
                
                // 确保行星严格按照轨道运动
                const x = Math.cos(data.angle) * data.distance;
                const z = Math.sin(data.angle) * data.distance;
                
                planet.position.set(x, 0, z);
                
                // 自转
                planet.rotation.y += 0.008 * speedMultiplier * timeDirection;
                
                // 处理月球
                if (data.key === 'earth') {
                    const moon = planet.children.find(child => child.userData && child.userData.name === '月球');
                    if (moon) {
                        moon.userData.angle += moon.userData.speed * speedMultiplier * timeDirection;
                        const moonX = Math.cos(moon.userData.angle) * 3.84;
                        moon.userData.angle += moon.userData.speed * speedMultiplier * timeDirection;
                        const moonX = Math.cos(moon.userData.angle) * 3.84;
                        const moonZ = Math.sin(moon.userData.angle) * 3.84;
                        moon.position.set(moonX, 0, moonZ);
                        moon.rotation.y += 0.05 * speedMultiplier * timeDirection;
                    }
                }
            });
        }

        // 显示天体信息
        function showPlanetInfo(data) {
            if (!data || !data.name) return;

            document.getElementById('planetName').textContent = data.name;
            document.getElementById('planetEnglish').textContent = data.english || '';
            
            const planetDataDiv = document.getElementById('planetData');
            let htmlContent = `
                <div class="planet-data">
                    <span class="data-label">类型:</span>
                    <span class="data-value">${data.type || '未知'}</span>
                </div>
            `;

            if (data.description) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">描述:</span>
                        <span class="data-value" style="font-size: 12px; line-height: 1.4;">${data.description}</span>
                    </div>
                `;
            }

            if (data.diameter) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">直径:</span>
                        <span class="data-value">${data.diameter}</span>
                    </div>
                `;
            }

            if (data.avgDistance) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">距太阳:</span>
                        <span class="data-value">${data.avgDistance}</span>
                    </div>
                `;
            }

            if (data.orbitalPeriod) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">公转周期:</span>
                        <span class="data-value">${data.orbitalPeriod}</span>
                    </div>
                `;
            }

            if (data.rotationPeriod) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">自转周期:</span>
                        <span class="data-value">${data.rotationPeriod}</span>
                    </div>
                `;
            }

            if (data.mass) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">质量:</span>
                        <span class="data-value">${data.mass}</span>
                    </div>
                `;
            }

            if (data.gravity) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">表面重力:</span>
                        <span class="data-value">${data.gravity}</span>
                    </div>
                `;
            }

            if (data.temperature) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">温度:</span>
                        <span class="data-value">${data.temperature}</span>
                    </div>
                `;
            }
            
            planetDataDiv.innerHTML = htmlContent;
            document.getElementById('planetInfo').classList.add('visible');
        }

        // 关闭行星信息
        function closePlanetInfo() {
            document.getElementById('planetInfo').classList.remove('visible');
        }

        // 设置相机视角
        function setCamera(mode) {
            // 移除所有相关按钮的active类
            document.querySelectorAll('#controls .btn').forEach(btn => {
                const text = btn.textContent;
                if (text.includes('全景') || text.includes('侧视') || text.includes('系仪') || text.includes('跟随')) {
                    btn.classList.remove('active');
                }
            });
            
            // 添加active类到当前按钮
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            currentCameraMode = mode;
            
            switch(mode) {
                case 'overview':
                    focusedPlanet = null;
                    camera.position.set(0, 120, 150);
                    camera.lookAt(0, 0, 0);
                    break;
                case 'side':
                    focusedPlanet = null;
                    camera.position.set(200, 0, 0);
                    camera.lookAt(0, 0, 0);
                    break;
                case 'orrery':
                    focusedPlanet = null;
                    camera.position.set(0, 300, 0);
                    camera.lookAt(0, 0, 0);
                    break;
                case 'follow':
                    if (!focusedPlanet) focusedPlanet = planets[2]; // 默认跟随地球
                    break;
            }
        }

        // 设置时间方向
        function setTimeDirection(direction) {
            timeDirection = direction;
            
            // 更新按钮状态
            document.getElementById('forwardBtn').classList.toggle('active', direction === 1);
            document.getElementById('reverseBtn').classList.toggle('active', direction === -1);
        }

        // 设置比例模式
        function setScaleMode(mode) {
            // 移除所有比例按钮的active类
            ['scaleMixedBtn', 'scaleDistanceBtn', 'scaleSizeBtn', 'scaleRealisticBtn'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            
            // 添加active类到当前按钮
            document.getElementById(`scale${mode.charAt(0).toUpperCase() + mode.slice(1)}Btn`).classList.add('active');
            
            scaleMode = mode;
            const info = document.getElementById('scaleInfo');
            
            planets.forEach((planet, index) => {
                const data = planet.userData;
                let newRadius, newDistance;
                
                switch(mode) {
                    case 'mixed':
                        newRadius = data.originalRadius * 1.5;
                        newDistance = data.originalDistance;
                        info.innerHTML = '当前模式：平衡模式<br>适合教学和观察的最佳平衡';
                        break;
                        
                    case 'distance':
                        newRadius = data.originalRadius * 2.5;
                        newDistance = data.originalDistance;
                        info.innerHTML = '当前模式：距离比例正确<br>行星大小被放大以便观察';
                        break;
                        
                    case 'size':
                        newRadius = data.originalRadius;
                        newDistance = data.originalDistance * 0.3;
                        info.innerHTML = '当前模式：大小比例正确<br>轨道距离被压缩以便观察';
                        break;
                        
                    case 'realistic':
                        newRadius = data.originalRadius * 0.05;
                        newDistance = data.originalDistance * 3;
                        info.innerHTML = '当前模式：真实比例<br>体验宇宙的真实尺度（行星极小）';
                        break;
                }
                
                // 更新行星几何体和数据
                planet.geometry.dispose();
                planet.geometry = new THREE.SphereGeometry(newRadius, 64, 64);
                planet.userData.radius = newRadius;
                planet.userData.distance = newDistance;
                
                // 更新轨道
                const orbit = orbits[index];
                if (orbit) {
                    orbit.geometry.dispose();
                    orbit.geometry = new THREE.RingGeometry(newDistance - 0.1, newDistance + 0.1, 256);
                }
                
                // 重新定位行星
                const planetAngle = planet.userData.angle;
                const newPlanetX = Math.cos(planetAngle) * newDistance;
                const newPlanetZ = Math.sin(planetAngle) * newDistance;
                planet.position.set(newPlanetX, 0, newPlanetZ);
            });
        }

        // 切换功能
        function toggleOrbits() {
            const show = document.getElementById('showOrbits').checked;
            orbits.forEach(orbit => {
                orbit.visible = show;
            });
        }

        function toggleAsteroids() {
            const show = document.getElementById('showAsteroids').checked;
            asteroids.forEach(asteroid => {
                asteroid.visible = show;
            });
        }

        function toggleComets() {
            const show = document.getElementById('showComets').checked;
            comets.forEach(comet => {
                comet.visible = show;
            });
        }

        function toggleTrails() {
            showTrails = document.getElementById('showTrails').checked;
            if (!showTrails) {
                // 清除现有轨迹
                scene.children = scene.children.filter(child => !child.userData.isTrail);
            }
        }

        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            panel.classList.toggle('visible');
        }

        function toggleEducation() {
            const panel = document.getElementById('educationPanel');
            panel.classList.toggle('visible');
        }

        function toggleHelp() {
            const panel = document.getElementById('helpPanel');
            panel.classList.toggle('visible');
        }

        function resetCamera() {
            setCamera('overview');
        }

        function pauseResume() {
            isPaused = !isPaused;
            const btn = event.target;
            btn.textContent = isPaused ? '继续' : '暂停';
            btn.classList.toggle('success', isPaused);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // 更新统计信息
        function updateStats() {
            const statsContent = document.getElementById('statsContent');
            
            statsContent.innerHTML = `
                <div style="margin-bottom: 10px;">帧率: ${fps} FPS</div>
                <div style="margin-bottom: 10px;">天体数量: ${planets.length + asteroids.length + comets.length + 1}</div>
                <div style="margin-bottom: 10px;">行星: ${planets.length}个</div>
                <div style="margin-bottom: 10px;">小行星: ${asteroids.length}个</div>
                <div style="margin-bottom: 10px;">彗星: ${comets.length}个</div>
                <div style="margin-bottom: 10px;">相机模式: ${currentCameraMode}</div>
                <div style="margin-bottom: 10px;">比例模式: ${scaleMode}</div>
                <div style="margin-bottom: 10px;">速度倍数: ${speedMultiplier}x</div>
                <div style="margin-bottom: 10px;">时间方向: ${timeDirection > 0 ? '正向' : '倒流'}</div>
                <div>跟随目标: ${focusedPlanet ? focusedPlanet.userData.name : '无'}</div>
            `;
        }

        // 更新轨迹
        function updateTrails() {
            if (!showTrails) return;
            
            planets.forEach(planet => {
                const key = planet.userData.key;
                const points = trailPoints[key];
                
                // 每10帧记录一次位置
                if (frameCount % 10 === 0) {
                    points.push(planet.position.clone());
                    
                    // 限制轨迹点数量
                    if (points.length > 300) {
                        points.shift();
                    }
                }
                
                // 创建或更新轨迹线
                const existingTrail = scene.getObjectByName(`trail_${key}`);
                if (existingTrail) {
                    scene.remove(existingTrail);
                }
                
                if (points.length > 2) {
                    const geometry = new THREE.BufferGeometry().setFromPoints(points);
                    const material = new THREE.LineBasicMaterial({
                        color: planet.material.color,
                        transparent: true,
                        opacity: 0.6
                    });
                    
                    const trail = new THREE.Line(geometry, material);
                    trail.name = `trail_${key}`;
                    trail.userData = { isTrail: true };
                    scene.add(trail);
                }
            });
        }

        // 更新FPS显示
        function updateFPS() {
            const currentTime = performance.now();
            if (lastTime === 0) {
                lastTime = currentTime;
                return;
            }
            
            const deltaTime = currentTime - lastTime;
            if (deltaTime >= 1000) { // 每秒更新一次FPS
                fps = Math.min(240, Math.round(frameCount * 1000 / deltaTime));
                document.getElementById('fpsDisplay').textContent = `${fps} FPS`;
                frameCount = 0;
                lastTime = currentTime;
            }
            frameCount++;
        }

        // 主动画循环
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            updateFPS();

            if (isPaused) {
                renderer.render(scene, camera);
                return;
            }

            // 太阳自转
            sun.rotation.y += 0.003 * speedMultiplier * timeDirection;

            // 更新行星位置（修正版）
            updatePlanetPositions();

            // 小行星带运动
            asteroids.forEach(asteroid => {
                const asteroidData = asteroid.userData;
                asteroidData.angle += asteroidData.speed * speedMultiplier * timeDirection;
                const asteroidX = Math.cos(asteroidData.angle) * asteroidData.distance;
                const asteroidZ = Math.sin(asteroidData.angle) * asteroidData.distance;
                asteroid.position.set(asteroidX, asteroid.position.y, asteroidZ);
                asteroid.rotation.x += asteroidData.rotationSpeed * speedMultiplier * timeDirection;
                asteroid.rotation.y += asteroidData.rotationSpeed * speedMultiplier * timeDirection;
            });

            // 彗星椭圆轨道运动
            comets.forEach(comet => {
                const cometData = comet.userData;
                cometData.angle += cometData.speed * speedMultiplier * timeDirection;
                
                const a = (cometData.aphelion + cometData.perihelion) / 2;
                const e = (cometData.aphelion - cometData.perihelion) / (cometData.aphelion + cometData.perihelion);
                const r = a * (1 - e * e) / (1 + e * Math.cos(cometData.angle));
                
                const cometX = Math.cos(cometData.angle) * r;
                const cometZ = Math.sin(cometData.angle) * r;
                comet.position.set(cometX, 0, cometZ);
                
                // 彗尾方向
                const sunDirection = new THREE.Vector3(0, 0, 0).sub(comet.position).normalize();
                if (comet.children[0]) {
                    const tailTarget = comet.position.clone().add(sunDirection.multiplyScalar(10));
                    comet.children[0].lookAt(tailTarget);
                }
            });

            // 优化的跟随相机
            updateFollowCamera();

            // 更新轨迹
            updateTrails();

            // 星空旋转
            if (starField) {
                starField.rotation.y += 0.0001 * speedMultiplier * timeDirection;
            }

            // 更新统计面板
            if (document.getElementById('statsPanel').classList.contains('visible')) {
                updateStats();
            }

            renderer.render(scene, camera);
        }

        // 启动应用
        init();
    </script>
</body>
</html>
