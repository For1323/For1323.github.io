<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Interactive Solar System 3D Model</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            overflow: hidden;
            color: white;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 320px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #a0a0ff;
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn.active {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 3px 10px rgba(245, 87, 108, 0.4);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn.success {
            background: linear-gradient(45deg, #51cf66 0%, #40c057 100%);
        }

        .speed-control, .time-control {
            width: 100%;
        }

        .speed-slider, .time-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            outline: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .speed-slider:hover, .time-slider:hover {
            opacity: 1;
        }

        .speed-value, .time-value {
            text-align: center;
            margin-top: 8px;
            color: #ffffff;
            font-weight: bold;
            font-size: 12px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 12px;
            color: #ffffff;
            cursor: pointer;
        }

        #planetInfo {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 350px;
            transform: translateX(400px);
            transition: transform 0.4s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        #planetInfo.visible {
            transform: translateX(0);
        }

        .planet-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .planet-english {
            font-size: 14px;
            color: #a0a0ff;
            margin-bottom: 20px;
            font-style: italic;
        }

        .planet-data {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .planet-data:last-child {
            border-bottom: none;
        }

        .data-label {
            color: #a0a0ff;
            font-weight: bold;
            font-size: 14px;
        }

        .data-value {
            color: white;
            font-weight: normal;
            text-align: right;
            font-size: 14px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #title {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            color: white;
        }

        .main-title {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: #a0a0ff;
            opacity: 0.8;
        }

        .scale-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a0a0ff;
            font-size: 12px;
            max-width: 280px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
            color: white;
            font-size: 18px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-panel {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            width: 280px;
            display: none;
        }

        .stats-panel.visible {
            display: block;
        }

        .trail-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }

        .mini-map {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 200px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .help-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .help-panel.visible {
            display: block;
        }

        .help-title {
            font-size: 20px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #667eea, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section h3 {
            color: #a0a0ff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .help-section p {
            color: white;
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨æ„å»ºå¤ªé˜³ç³»...</p>
        </div>

        <div id="controls">
            <div class="control-group">
                <label class="control-label">è§†è§’åˆ‡æ¢</label>
                <div class="button-group">
                    <button class="btn active" onclick="setCamera('overview')">å…¨æ™¯</button>
                    <button class="btn" onclick="setCamera('side')">ä¾§è§†</button>
                    <button class="btn" onclick="setCamera('orrery')">å¤ªé˜³ç³»ä»ª</button>
                    <button class="btn" onclick="setCamera('follow')">è·Ÿéšåœ°çƒ</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">å…¬è½¬é€Ÿåº¦</label>
                <div class="speed-control">
                    <input type="range" class="speed-slider" min="0" max="20" step="0.1" value="1" id="speedSlider">
                    <div class="speed-value" id="speedValue">1.0x</div>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">æ—¶é—´æµé€</label>
                <div class="time-control">
                    <input type="range" class="time-slider" min="-10" max="10" step="0.1" value="1" id="timeSlider">
                    <div class="time-value" id="timeValue">æ­£å¸¸æ—¶é—´</div>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">æ˜¾ç¤ºæ¨¡å¼</label>
                <div class="button-group">
                    <button class="btn active" onclick="setScaleMode('mixed')" id="scaleMixedBtn">å¹³è¡¡æ¨¡å¼</button>
                    <button class="btn" onclick="setScaleMode('distance')" id="scaleDistanceBtn">è·ç¦»æ¯”ä¾‹</button>
                    <button class="btn" onclick="setScaleMode('size')" id="scaleSizeBtn">å¤§å°æ¯”ä¾‹</button>
                    <button class="btn" onclick="setScaleMode('realistic')" id="scaleRealisticBtn">çœŸå®æ¯”ä¾‹</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">æ˜¾ç¤ºé€‰é¡¹</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showOrbits" checked onchange="toggleOrbits()">
                        <label for="showOrbits">è½¨é“çº¿</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showAsteroids" checked onchange="toggleAsteroids()">
                        <label for="showAsteroids">å°è¡Œæ˜Ÿå¸¦</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showComets" checked onchange="toggleComets()">
                        <label for="showComets">å½—æ˜Ÿ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showTrails" onchange="toggleTrails()">
                        <label for="showTrails">è½¨è¿¹</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showLabels" onchange="toggleLabels()">
                        <label for="showLabels">æ ‡ç­¾</label>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">åŠŸèƒ½</label>
                <div class="button-group">
                    <button class="btn" onclick="toggleStats()">ç»Ÿè®¡é¢æ¿</button>
                    <button class="btn success" onclick="resetCamera()">é‡ç½®è§†è§’</button>
                    <button class="btn" onclick="toggleHelp()">å¸®åŠ©</button>
                    <button class="btn danger" onclick="pauseResume()">æš‚åœ</button>
                </div>
            </div>
        </div>

        <div id="planetInfo">
            <button class="close-btn" onclick="closePlanetInfo()">Ã—</button>
            <div class="planet-name" id="planetName"></div>
            <div class="planet-english" id="planetEnglish"></div>
            <div id="planetData"></div>
        </div>

        <div class="stats-panel" id="statsPanel">
            <h3 style="color: #a0a0ff; margin-bottom: 15px;">å®æ—¶ç»Ÿè®¡</h3>
            <div id="statsContent"></div>
        </div>

        <div class="help-panel" id="helpPanel">
            <button class="close-btn" onclick="toggleHelp()">Ã—</button>
            <h2 class="help-title">å¤ªé˜³ç³»3Dæ¨¡å‹ - ä½¿ç”¨æŒ‡å—</h2>
            
            <div class="help-section">
                <h3>ğŸ® åŸºç¡€æ“ä½œ</h3>
                <p>â€¢ é¼ æ ‡æ‹–æ‹½ï¼šæ—‹è½¬è§†è§’</p>
                <p>â€¢ é¼ æ ‡æ»šè½®ï¼šç¼©æ”¾è§†è·</p>
                <p>â€¢ ç‚¹å‡»å¤©ä½“ï¼šæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
                <p>â€¢ åŒå‡»è¡Œæ˜Ÿï¼šèšç„¦è·Ÿéšæ¨¡å¼</p>
            </div>

            <div class="help-section">
                <h3>ğŸ“ æ˜¾ç¤ºæ¨¡å¼è¯´æ˜</h3>
                <p>â€¢ å¹³è¡¡æ¨¡å¼ï¼šæ•™å­¦å‹å¥½ï¼Œè·ç¦»å’Œå¤§å°éƒ½é€‚ä¸­</p>
                <p>â€¢ è·ç¦»æ¯”ä¾‹ï¼šçœŸå®è·ç¦»æ¯”ä¾‹ï¼Œè¡Œæ˜Ÿå¤§å°æ”¾å¤§</p>
                <p>â€¢ å¤§å°æ¯”ä¾‹ï¼šçœŸå®å¤§å°æ¯”ä¾‹ï¼Œè·ç¦»å‹ç¼©</p>
                <p>â€¢ çœŸå®æ¯”ä¾‹ï¼šå®Œå…¨çœŸå®æ¯”ä¾‹ï¼ˆè¡Œæ˜Ÿæå°ï¼‰</p>
            </div>

            <div class="help-section">
                <h3>â° æ—¶é—´æ§åˆ¶</h3>
                <p>â€¢ é€Ÿåº¦æ»‘å—ï¼šæ§åˆ¶å…¬è½¬é€Ÿåº¦ï¼ˆ0-20å€ï¼‰</p>
                <p>â€¢ æ—¶é—´æ»‘å—ï¼šæ—¶é—´å€’æµæˆ–å¿«è¿›</p>
                <p>â€¢ è´Ÿå€¼ï¼šæ—¶é—´å€’æµï¼Œè¡Œæ˜Ÿé€†å‘è¿åŠ¨</p>
            </div>

            <div class="help-section">
                <h3>ğŸŒŒ ç‰¹æ®Šå¤©ä½“</h3>
                <p>â€¢ å°è¡Œæ˜Ÿå¸¦ï¼šç«æ˜Ÿå’Œæœ¨æ˜Ÿé—´çš„å°è¡Œæ˜Ÿç¾¤</p>
                <p>â€¢ å½—æ˜Ÿï¼šæ¤­åœ†è½¨é“ï¼Œæ‹–ç€å…‰å°¾çš„å½—æ˜Ÿ</p>
                <p>â€¢ åœŸæ˜Ÿç¯ï¼šåœŸæ˜Ÿç‹¬ç‰¹çš„è¡Œæ˜Ÿç¯ç³»ç»Ÿ</p>
            </div>
        </div>

        <div id="title">
            <h1 class="main-title">å¢å¼ºç‰ˆå¤ªé˜³ç³» 3D æ¨¡å‹</h1>
            <p class="subtitle">æ¢ç´¢å®‡å®™å¥¥ç§˜ â€¢ åŒå‡»è¡Œæ˜Ÿè·Ÿéš â€¢ æ”¯æŒæ—¶é—´å€’æµ â€¢ Fé”®å…¨å±</p>
        </div>

        <div class="scale-info" id="scaleInfo">
            å½“å‰æ¨¡å¼ï¼šå¹³è¡¡æ¨¡å¼<br>
            é€‚åˆæ•™å­¦å’Œè§‚å¯Ÿçš„æœ€ä½³å¹³è¡¡
        </div>

        <canvas class="mini-map" id="miniMap"></canvas>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let planets = [];
        let orbits = [];
        let asteroids = [];
        let comets = [];
        let labels = [];
        let sun;
        let speedMultiplier = 1;
        let timeDirection = 1;
        let currentCameraMode = 'overview';
        let scaleMode = 'mixed'; // 'mixed', 'distance', 'size', 'realistic'
        let animationId;
        let starField;
        let focusedPlanet = null;
        let isPaused = false;
        let showTrails = false;
        let trailPoints = {};
        
        // è¡Œæ˜Ÿæ•°æ®ï¼ˆå¢å¼ºç‰ˆï¼‰
        const planetData = {
            mercury: {
                name: 'æ°´æ˜Ÿ', english: 'Mercury',
                realRadius: 0.38, realDistance: 10, speed: 0.024, color: 0x8c7853,
                diameter: '4,879 km', avgDistance: '5,790ä¸‡ km', 
                orbitalPeriod: '88å¤©', rotationPeriod: '59å¤©', type: 'å²©çŸ³è¡Œæ˜Ÿ',
                mass: '3.3 Ã— 10Â²Â³ kg', gravity: '3.7 m/sÂ²', temperature: '-173~427Â°C'
            },
            venus: {
                name: 'é‡‘æ˜Ÿ', english: 'Venus',
                realRadius: 0.95, realDistance: 15, speed: 0.018, color: 0xffc649,
                diameter: '12,104 km', avgDistance: '1.08äº¿ km',
                orbitalPeriod: '225å¤©', rotationPeriod: '243å¤©', type: 'å²©çŸ³è¡Œæ˜Ÿ',
                mass: '4.87 Ã— 10Â²â´ kg', gravity: '8.87 m/sÂ²', temperature: '462Â°C'
            },
            earth: {
                name: 'åœ°çƒ', english: 'Earth',
                realRadius: 1, realDistance: 20, speed: 0.015, color: 0x6b93d6,
                diameter: '12,756 km', avgDistance: '1.5äº¿ km',
                orbitalPeriod: '365å¤©', rotationPeriod: '24å°æ—¶', type: 'å²©çŸ³è¡Œæ˜Ÿ',
                mass: '5.97 Ã— 10Â²â´ kg', gravity: '9.8 m/sÂ²', temperature: '-89~58Â°C'
            },
            mars: {
                name: 'ç«æ˜Ÿ', english: 'Mars',
                realRadius: 0.53, realDistance: 25, speed: 0.012, color: 0xc1440e,
                diameter: '6,792 km', avgDistance: '2.28äº¿ km',
                orbitalPeriod: '687å¤©', rotationPeriod: '24.6å°æ—¶', type: 'å²©çŸ³è¡Œæ˜Ÿ',
                mass: '6.42 Ã— 10Â²Â³ kg', gravity: '3.71 m/sÂ²', temperature: '-87~-5Â°C'
            },
            jupiter: {
                name: 'æœ¨æ˜Ÿ', english: 'Jupiter',
                realRadius: 3, realDistance: 40, speed: 0.006, color: 0xd8ca9d,
                diameter: '142,984 km', avgDistance: '7.79äº¿ km',
                orbitalPeriod: '12å¹´', rotationPeriod: '9.9å°æ—¶', type: 'æ°”æ€å·¨æ˜Ÿ',
                mass: '1.90 Ã— 10Â²â· kg', gravity: '24.79 m/sÂ²', temperature: '-108Â°C'
            },
            saturn: {
                name: 'åœŸæ˜Ÿ', english: 'Saturn',
                realRadius: 2.5, realDistance: 55, speed: 0.004, color: 0xfad5a5,
                diameter: '120,536 km', avgDistance: '14.3äº¿ km',
                orbitalPeriod: '29å¹´', rotationPeriod: '10.7å°æ—¶', type: 'æ°”æ€å·¨æ˜Ÿ',
                mass: '5.68 Ã— 10Â²â¶ kg', gravity: '10.44 m/sÂ²', temperature: '-139Â°C'
            },
            uranus: {
                name: 'å¤©ç‹æ˜Ÿ', english: 'Uranus',
                realRadius: 1.5, realDistance: 70, speed: 0.003, color: 0x4fd0e7,
                diameter: '51,118 km', avgDistance: '28.7äº¿ km',
                orbitalPeriod: '84å¹´', rotationPeriod: '17.2å°æ—¶', type: 'å†°å·¨æ˜Ÿ',
                mass: '8.68 Ã— 10Â²âµ kg', gravity: '8.69 m/sÂ²', temperature: '-197Â°C'
            },
            neptune: {
                name: 'æµ·ç‹æ˜Ÿ', english: 'Neptune',
                realRadius: 1.4, realDistance: 85, speed: 0.002, color: 0x4b70dd,
                diameter: '49,528 km', avgDistance: '45.0äº¿ km',
                orbitalPeriod: '165å¹´', rotationPeriod: '16.1å°æ—¶', type: 'å†°å·¨æ˜Ÿ',
                mass: '1.02 Ã— 10Â²â¶ kg', gravity: '11.15 m/sÂ²', temperature: '-201Â°C'
            }
        };

        // å½—æ˜Ÿæ•°æ®
        const cometData = [
            {
                name: 'å“ˆé›·å½—æ˜Ÿ', english: 'Halley\'s Comet',
                perihelion: 15, aphelion: 80, speed: 0.008, color: 0x88ccff,
                orbitalPeriod: '76å¹´', type: 'å‘¨æœŸå½—æ˜Ÿ'
            },
            {
                name: 'æ©å…‹å½—æ˜Ÿ', english: 'Encke\'s Comet',
                perihelion: 8, aphelion: 35, speed: 0.015, color: 0xaaffcc,
                orbitalPeriod: '3.3å¹´', type: 'çŸ­å‘¨æœŸå½—æ˜Ÿ'
            }
        ];

        // åˆå§‹åŒ–åœºæ™¯
        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();

            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
            camera.position.set(0, 80, 120);

            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);

            // åˆ›å»ºæ˜Ÿç©ºèƒŒæ™¯
            createStarField();

            // åˆ›å»ºå¤ªé˜³
            createSun();

            // åˆ›å»ºè¡Œæ˜Ÿå’Œè½¨é“
            createPlanets();

            // åˆ›å»ºå°è¡Œæ˜Ÿå¸¦
            createAsteroidBelt();

            // åˆ›å»ºå½—æ˜Ÿ
            createComets();

            // åˆ›å»ºå…‰æº
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            scene.add(ambientLight);

            const sunLight = new THREE.PointLight(0xffffff, 2, 1000);
            sunLight.position.set(0, 0, 0);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.far = 1000;
            scene.add(sunLight);

            // è®¾ç½®æ§åˆ¶å™¨
            setupControls();

            // è®¾ç½®äº‹ä»¶ç›‘å¬
            setupEventListeners();

            // åˆå§‹åŒ–è½¨è¿¹è¿½è¸ª
            initTrailTracking();

            // åˆ›å»ºå°åœ°å›¾
            // createMiniMap();

            // éšè—åŠ è½½ç•Œé¢
            document.getElementById('loading').style.display = 'none';

            // å¼€å§‹åŠ¨ç”»
            animate();
        }

        // åˆ›å»ºæ˜Ÿç©ºèƒŒæ™¯
        function createStarField() {
            const geometry = new THREE.SphereGeometry(1500, 64, 64);
            const material = new THREE.MeshBasicMaterial({
                color: 0x000022,
                side: THREE.BackSide
            });
            starField = new THREE.Mesh(geometry, material);
            
            // æ·»åŠ æ˜Ÿç‚¹
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 2,
                sizeAttenuation: false
            });

            const starVertices = [];
            for (let i = 0; i < 15000; i++) {
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(Math.random() * 2 - 1);
                const r = 1200 + Math.random() * 300;
                
                starVertices.push(
                    r * Math.sin(phi) * Math.cos(theta),
                    r * Math.sin(phi) * Math.sin(theta),
                    r * Math.cos(phi)
                );
            }

            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const stars = new THREE.Points(starGeometry, starMaterial);
            
            scene.add(starField);
            scene.add(stars);
        }

        // åˆ›å»ºå¤ªé˜³
        function createSun() {
            const sunGeometry = new THREE.SphereGeometry(5, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({
                color: 0xffff00,
                emissive: 0xff6600,
                emissiveIntensity: 0.6
            });
            
            sun = new THREE.Mesh(sunGeometry, sunMaterial);
            sun.castShadow = false;
            sun.userData = { 
                name: 'å¤ªé˜³', 
                english: 'Sun',
                diameter: '1,392,700 km',
                avgDistance: '0 km',
                orbitalPeriod: 'ä¸é€‚ç”¨',
                rotationPeriod: '25å¤©',
                type: 'æ’æ˜Ÿ',
                mass: '1.99 Ã— 10Â³â° kg',
                temperature: '5,778K (è¡¨é¢)'
            };
            scene.add(sun);
        }

        // åˆ›å»ºè¡Œæ˜Ÿ
        function createPlanets() {
            const planetKeys = Object.keys(planetData);
            
            planetKeys.forEach((key, index) => {
                const data = planetData[key];
                
                // åˆ›å»ºè½¨é“
                const orbitGeometry = new THREE.RingGeometry(data.realDistance - 0.2, data.realDistance + 0.2, 128);
                const orbitMaterial = new THREE.MeshBasicMaterial({
                    color: 0x444444,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.3
                });
                const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                orbit.rotation.x = -Math.PI / 2;
                orbit.userData = { type: 'orbit' };
                scene.add(orbit);
                orbits.push(orbit);

                // åˆ›å»ºè¡Œæ˜Ÿ
                const planetGeometry = new THREE.SphereGeometry(data.realRadius, 32, 32);
                const planetMaterial = new THREE.MeshLambertMaterial({ color: data.color });
                const planet = new THREE.Mesh(planetGeometry, planetMaterial);
                
                planet.position.x = data.realDistance;
                planet.castShadow = true;
                planet.receiveShadow = true;
                
                planet.userData = {
                    ...data,
                    key: key,
                    angle: Math.random() * Math.PI * 2,
                    originalRadius: data.realRadius,
                    originalDistance: data.realDistance
                };
                
                scene.add(planet);
                planets.push(planet);

                // ä¸ºåœŸæ˜Ÿæ·»åŠ å…‰ç¯
                if (key === 'saturn') {
                    const ringGeometry = new THREE.RingGeometry(data.realRadius * 1.5, data.realRadius * 2.5, 64);
                    const ringMaterial = new THREE.MeshBasicMaterial({
                        color: 0xccccaa,
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: 0.7
                    });
                    const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                    ring.rotation.x = -Math.PI / 2;
                    ring.rotation.z = Math.PI / 8; // ç¨å¾®å€¾æ–œ
                    planet.add(ring);
                }

                // ä¸ºåœ°çƒæ·»åŠ æœˆçƒ
                if (key === 'earth') {
                    const moonGeometry = new THREE.SphereGeometry(0.27, 16, 16);
                    const moonMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
                    const moon = new THREE.Mesh(moonGeometry, moonMaterial);
                    moon.position.x = 3;
                    moon.userData = {
                        name: 'æœˆçƒ', english: 'Moon', type: 'å¤©ç„¶å«æ˜Ÿ',
                        angle: 0, speed: 0.05
                    };
                    planet.add(moon);
                }
            });
        }

        // åˆ›å»ºå°è¡Œæ˜Ÿå¸¦
        function createAsteroidBelt() {
            const asteroidCount = 800;
            const minDistance = 30;
            const maxDistance = 38;

            for (let i = 0; i < asteroidCount; i++) {
                const distance = minDistance + Math.random() * (maxDistance - minDistance);
                const angle = Math.random() * Math.PI * 2;
                const size = 0.05 + Math.random() * 0.15;

                const asteroidGeometry = new THREE.SphereGeometry(size, 6, 6);
                const asteroidMaterial = new THREE.MeshLambertMaterial({ 
                    color: new THREE.Color().setHSL(0.1, 0.3, 0.2 + Math.random() * 0.3)
                });
                
                const asteroid = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
                asteroid.position.x = Math.cos(angle) * distance;
                asteroid.position.z = Math.sin(angle) * distance;
                asteroid.position.y = (Math.random() - 0.5) * 2;
                
                asteroid.userData = {
                    type: 'asteroid',
                    distance: distance,
                    angle: angle,
                    speed: 0.001 + Math.random() * 0.002,
                    rotationSpeed: (Math.random() - 0.5) * 0.1
                };
                
                scene.add(asteroid);
                asteroids.push(asteroid);
            }
        }

        // åˆ›å»ºå½—æ˜Ÿ
        function createComets() {
            cometData.forEach(data => {
                // åˆ›å»ºå½—æ˜Ÿå¤´éƒ¨
                const cometGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                const cometMaterial = new THREE.MeshLambertMaterial({ 
                    color: data.color,
                    emissive: data.color,
                    emissiveIntensity: 0.2
                });
                
                const comet = new THREE.Mesh(cometGeometry, cometMaterial);
                comet.position.x = data.perihelion;
                
                // åˆ›å»ºå½—å°¾
                const tailGeometry = new THREE.ConeGeometry(0.5, 8, 8);
                const tailMaterial = new THREE.MeshBasicMaterial({
                    color: data.color,
                    transparent: true,
                    opacity: 0.3
                });
                const tail = new THREE.Mesh(tailGeometry, tailMaterial);
                tail.rotation.z = Math.PI / 2;
                tail.position.x = -4;
                comet.add(tail);

                comet.userData = {
                    ...data,
                    type: 'comet',
                    angle: 0,
                    currentDistance: data.perihelion,
                    direction: 1
                };
                
                scene.add(comet);
                comets.push(comet);
            });
        }

        // åˆå§‹åŒ–è½¨è¿¹è¿½è¸ª
        function initTrailTracking() {
            planets.forEach(planet => {
                trailPoints[planet.userData.key] = [];
            });
        }

        // è®¾ç½®æ§åˆ¶å™¨
        function setupControls() {
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;

            renderer.domElement.addEventListener('mousedown', (event) => {
                mouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            renderer.domElement.addEventListener('mouseup', () => {
                mouseDown = false;
            });

            renderer.domElement.addEventListener('mousemove', (event) => {
                if (!mouseDown) return;

                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;

                if (currentCameraMode !== 'follow') {
                    const spherical = new THREE.Spherical();
                    spherical.setFromVector3(camera.position);
                    
                    spherical.theta -= deltaX * 0.01;
                    spherical.phi += deltaY * 0.01;
                    spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));

                    camera.position.setFromSpherical(spherical);
                    camera.lookAt(0, 0, 0);
                }

                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            renderer.domElement.addEventListener('wheel', (event) => {
                if (currentCameraMode !== 'follow') {
                    const distance = camera.position.length();
                    const newDistance = distance + event.deltaY * 0.5;
                    
                    if (newDistance > 10 && newDistance < 1000) {
                        camera.position.normalize();
                        camera.position.multiplyScalar(newDistance);
                    }
                }
            });

            // åŒå‡»èšç„¦
            renderer.domElement.addEventListener('dblclick', onPlanetDoubleClick);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // é€Ÿåº¦æ»‘å—
            const speedSlider = document.getElementById('speedSlider');
            speedSlider.addEventListener('input', (e) => {
                speedMultiplier = parseFloat(e.target.value);
                document.getElementById('speedValue').textContent = speedMultiplier.toFixed(1) + 'x';
            });

            // æ—¶é—´æ»‘å—
            const timeSlider = document.getElementById('timeSlider');
            timeSlider.addEventListener('input', (e) => {
                timeDirection = parseFloat(e.target.value);
                const timeValue = document.getElementById('timeValue');
                if (timeDirection > 0) {
                    timeValue.textContent = `å¿«è¿› ${timeDirection.toFixed(1)}x`;
                } else if (timeDirection < 0) {
                    timeValue.textContent = `å€’æµ ${Math.abs(timeDirection).toFixed(1)}x`;
                } else {
                    timeValue.textContent = 'æ—¶é—´åœæ­¢';
                }
            });

            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // ç‚¹å‡»è¡Œæ˜Ÿ
            renderer.domElement.addEventListener('click', onPlanetClick);

            // é”®ç›˜äº‹ä»¶
            window.addEventListener('keydown', onKeyDown);
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function onKeyDown(event) {
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    pauseResume();
                    break;
                case 'KeyF':
                    toggleFullscreen();
                    break;
                case 'KeyR':
                    resetCamera();
                    break;
                case 'KeyH':
                    toggleHelp();
                    break;
                case 'KeyS':
                    toggleStats();
                    break;
            }
        }

        // è¡Œæ˜Ÿç‚¹å‡»äº‹ä»¶
        function onPlanetClick(event) {
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            const allObjects = [sun, ...planets, ...asteroids, ...comets];
            const intersects = raycaster.intersectObjects(allObjects);
            
            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                showPlanetInfo(clickedObject.userData);
            }
        }

        // åŒå‡»èšç„¦äº‹ä»¶
        function onPlanetDoubleClick(event) {
            const mouse = new THREE.Vector2();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(planets);
            
            if (intersects.length > 0) {
                focusedPlanet = intersects[0].object;
                setCamera('follow');
            }
        }

        // æ˜¾ç¤ºè¡Œæ˜Ÿä¿¡æ¯
        function showPlanetInfo(data) {
            if (!data || !data.name) return;

            document.getElementById('planetName').textContent = data.name;
            document.getElementById('planetEnglish').textContent = data.english || '';
            
            const planetDataDiv = document.getElementById('planetData');
            let htmlContent = `
                <div class="planet-data">
                    <span class="data-label">ç±»å‹:</span>
                    <span class="data-value">${data.type || 'æœªçŸ¥'}</span>
                </div>
            `;

            if (data.diameter) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">ç›´å¾„:</span>
                        <span class="data-value">${data.diameter}</span>
                    </div>
                `;
            }

            if (data.avgDistance) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">ä¸å¤ªé˜³è·ç¦»:</span>
                        <span class="data-value">${data.avgDistance}</span>
                    </div>
                `;
            }

            if (data.orbitalPeriod) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">å…¬è½¬å‘¨æœŸ:</span>
                        <span class="data-value">${data.orbitalPeriod}</span>
                    </div>
                `;
            }

            if (data.rotationPeriod) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">è‡ªè½¬å‘¨æœŸ:</span>
                        <span class="data-value">${data.rotationPeriod}</span>
                    </div>
                `;
            }

            if (data.mass) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">è´¨é‡:</span>
                        <span class="data-value">${data.mass}</span>
                    </div>
                `;
            }

            if (data.gravity) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">è¡¨é¢é‡åŠ›:</span>
                        <span class="data-value">${data.gravity}</span>
                    </div>
                `;
            }

            if (data.temperature) {
                htmlContent += `
                    <div class="planet-data">
                        <span class="data-label">æ¸©åº¦:</span>
                        <span class="data-value">${data.temperature}</span>
                    </div>
                `;
            }
            
            planetDataDiv.innerHTML = htmlContent;
            document.getElementById('planetInfo').classList.add('visible');
        }

        // å…³é—­è¡Œæ˜Ÿä¿¡æ¯
        function closePlanetInfo() {
            document.getElementById('planetInfo').classList.remove('visible');
        }

        // è®¾ç½®ç›¸æœºè§†è§’
        function setCamera(mode) {
            // ç§»é™¤æ‰€æœ‰ç›¸å…³æŒ‰é’®çš„activeç±»
            document.querySelectorAll('#controls .btn').forEach(btn => {
                const text = btn.textContent;
                if (text.includes('å…¨æ™¯') || text.includes('ä¾§è§†') || text.includes('ç³»ä»ª') || text.includes('è·Ÿéš')) {
                    btn.classList.remove('active');
                }
            });
            
            // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            currentCameraMode = mode;
            focusedPlanet = null;
            
            switch(mode) {
                case 'overview':
                    camera.position.set(0, 120, 150);
                    camera.lookAt(0, 0, 0);
                    break;
                case 'side':
                    camera.position.set(200, 0, 0);
                    camera.lookAt(0, 0, 0);
                    break;
                case 'orrery':
                    camera.position.set(0, 300, 0);
                    camera.lookAt(0, 0, 0);
                    break;
                case 'follow':
                    if (!focusedPlanet) focusedPlanet = planets[2]; // é»˜è®¤è·Ÿéšåœ°çƒ
                    break;
            }
        }

        // è®¾ç½®æ¯”ä¾‹æ¨¡å¼
        function setScaleMode(mode) {
            // ç§»é™¤æ‰€æœ‰æ¯”ä¾‹æŒ‰é’®çš„activeç±»
            ['scaleMixedBtn', 'scaleDistanceBtn', 'scaleSizeBtn', 'scaleRealisticBtn'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            
            // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
            document.getElementById(`scale${mode.charAt(0).toUpperCase() + mode.slice(1)}Btn`).classList.add('active');
            
            scaleMode = mode;
            const info = document.getElementById('scaleInfo');
            
            planets.forEach((planet, index) => {
                const data = planet.userData;
                let newRadius, newDistance;
                
                switch(mode) {
                    case 'mixed':
                        // å¹³è¡¡æ¨¡å¼ï¼šæ•™å­¦å‹å¥½
                        newRadius = data.originalRadius * 1.5;
                        newDistance = data.originalDistance;
                        info.innerHTML = 'å½“å‰æ¨¡å¼ï¼šå¹³è¡¡æ¨¡å¼<br>é€‚åˆæ•™å­¦å’Œè§‚å¯Ÿçš„æœ€ä½³å¹³è¡¡';
                        break;
                        
                    case 'distance':
                        // è·ç¦»æ¯”ä¾‹æ­£ç¡®
                        newRadius = data.originalRadius * 2;
                        newDistance = data.originalDistance;
                        info.innerHTML = 'å½“å‰æ¨¡å¼ï¼šè·ç¦»æ¯”ä¾‹æ­£ç¡®<br>è¡Œæ˜Ÿå¤§å°è¢«æ”¾å¤§ä»¥ä¾¿è§‚å¯Ÿ';
                        break;
                        
                    case 'size':
                        // å¤§å°æ¯”ä¾‹æ­£ç¡®
                        newRadius = data.originalRadius;
                        newDistance = data.originalDistance * 0.4;
                        info.innerHTML = 'å½“å‰æ¨¡å¼ï¼šå¤§å°æ¯”ä¾‹æ­£ç¡®<br>è½¨é“è·ç¦»è¢«å‹ç¼©ä»¥ä¾¿è§‚å¯Ÿ';
                        break;
                        
                    case 'realistic':
                        // å®Œå…¨çœŸå®æ¯”ä¾‹
                        newRadius = data.originalRadius * 0.1;
                        newDistance = data.originalDistance * 2;
                        info.innerHTML = 'å½“å‰æ¨¡å¼ï¼šçœŸå®æ¯”ä¾‹<br>è¡Œæ˜Ÿæå°ï¼Œä½“éªŒçœŸå®å®‡å®™å°ºåº¦';
                        break;
                }
                
                // æ›´æ–°è¡Œæ˜Ÿå‡ ä½•ä½“
                planet.geometry.dispose();
                planet.geometry = new THREE.SphereGeometry(newRadius, 32, 32);
                planet.userData.radius = newRadius;
                planet.userData.distance = newDistance;
                
                // æ›´æ–°è½¨é“
                const orbit = orbits[index];
                if (orbit) {
                    orbit.geometry.dispose();
                    orbit.geometry = new THREE.RingGeometry(newDistance - 0.2, newDistance + 0.2, 128);
                }
            });
        }

        // åˆ‡æ¢è½¨é“æ˜¾ç¤º
        function toggleOrbits() {
            const show = document.getElementById('showOrbits').checked;
            orbits.forEach(orbit => {
                orbit.visible = show;
            });
        }

        // åˆ‡æ¢å°è¡Œæ˜Ÿå¸¦æ˜¾ç¤º
        function toggleAsteroids() {
            const show = document.getElementById('showAsteroids').checked;
            asteroids.forEach(asteroid => {
                asteroid.visible = show;
            });
        }

        // åˆ‡æ¢å½—æ˜Ÿæ˜¾ç¤º
        function toggleComets() {
            const show = document.getElementById('showComets').checked;
            comets.forEach(comet => {
                comet.visible = show;
            });
        }

        // åˆ‡æ¢è½¨è¿¹æ˜¾ç¤º
        function toggleTrails() {
            showTrails = document.getElementById('showTrails').checked;
            if (!showTrails) {
                // æ¸…é™¤ç°æœ‰è½¨è¿¹
                scene.children = scene.children.filter(child => !child.userData.isTrail);
            }
        }

        // åˆ‡æ¢æ ‡ç­¾æ˜¾ç¤º
        function toggleLabels() {
            const show = document.getElementById('showLabels').checked;
            // æ ‡ç­¾åŠŸèƒ½å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
            console.log('æ ‡ç­¾æ˜¾ç¤º:', show);
        }

        // åˆ‡æ¢ç»Ÿè®¡é¢æ¿
        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            panel.classList.toggle('visible');
            if (panel.classList.contains('visible')) {
                updateStats();
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const statsContent = document.getElementById('statsContent');
            const frameRate = Math.round(1000 / 16.67); // ç®€åŒ–çš„FPSè®¡ç®—
            
            statsContent.innerHTML = `
                <div style="margin-bottom: 10px;">å¸§ç‡: ${frameRate} FPS</div>
                <div style="margin-bottom: 10px;">å¤©ä½“æ•°é‡: ${planets.length + asteroids.length + comets.length + 1}</div>
                <div style="margin-bottom: 10px;">å°è¡Œæ˜Ÿ: ${asteroids.length}ä¸ª</div>
                <div style="margin-bottom: 10px;">å½—æ˜Ÿ: ${comets.length}ä¸ª</div>
                <div style="margin-bottom: 10px;">ç›¸æœºæ¨¡å¼: ${currentCameraMode}</div>
                <div style="margin-bottom: 10px;">æ¯”ä¾‹æ¨¡å¼: ${scaleMode}</div>
                <div style="margin-bottom: 10px;">é€Ÿåº¦å€æ•°: ${speedMultiplier}x</div>
                <div>æ—¶é—´æ–¹å‘: ${timeDirection > 0 ? 'æ­£å‘' : timeDirection < 0 ? 'å€’æµ' : 'åœæ­¢'}</div>
            `;
        }

        // é‡ç½®ç›¸æœº
        function resetCamera() {
            setCamera('overview');
        }

        // æš‚åœ/æ¢å¤
        function pauseResume() {
            isPaused = !isPaused;
            const btn = event.target;
            btn.textContent = isPaused ? 'ç»§ç»­' : 'æš‚åœ';
            btn.classList.toggle('success', isPaused);
        }

        // åˆ‡æ¢å¸®åŠ©é¢æ¿
        function toggleHelp() {
            const panel = document.getElementById('helpPanel');
            panel.classList.toggle('visible');
        }

        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // æ›´æ–°è½¨è¿¹
        function updateTrails() {
            if (!showTrails) return;
            
            planets.forEach(planet => {
                const key = planet.userData.key;
                const points = trailPoints[key];
                
                points.push(planet.position.clone());
                
                // é™åˆ¶è½¨è¿¹ç‚¹æ•°é‡
                if (points.length > 500) {
                    points.shift();
                }
                
                // åˆ›å»ºæˆ–æ›´æ–°è½¨è¿¹çº¿
                const existingTrail = scene.getObjectByName(`trail_${key}`);
                if (existingTrail) {
                    scene.remove(existingTrail);
                }
                
                if (points.length > 1) {
                    const geometry = new THREE.BufferGeometry().setFromPoints(points);
                    const material = new THREE.LineBasicMaterial({
                        color: planet.material.color,
                        transparent: true,
                        opacity: 0.5
                    });
                    
                    const trail = new THREE.Line(geometry, material);
                    trail.name = `trail_${key}`;
                    trail.userData = { isTrail: true };
                    scene.add(trail);
                }
            });
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            animationId = requestAnimationFrame(animate);

            if (isPaused) {
                renderer.render(scene, camera);
                return;
            }

            const effectiveSpeed = speedMultiplier * timeDirection;

            // æ—‹è½¬å¤ªé˜³
            sun.rotation.y += 0.005 * effectiveSpeed;

            // è¡Œæ˜Ÿå…¬è½¬å’Œè‡ªè½¬
            planets.forEach(planet => {
                const data = planet.userData;
                
                // å…¬è½¬
                data.angle += data.speed * effectiveSpeed;
                planet.position.x = Math.cos(data.angle) * data.distance;
                planet.position.z = Math.sin(data.angle) * data.distance;
                
                // è‡ªè½¬
                planet.rotation.y += 0.01 * effectiveSpeed;
                
                // æœˆçƒç»•åœ°çƒè¿åŠ¨
                if (data.key === 'earth') {
                    const moon = planet.children.find(child => child.userData.name === 'æœˆçƒ');
                    if (moon) {
                        moon.userData.angle += moon.userData.speed * effectiveSpeed;
                        moon.position.x = Math.cos(moon.userData.angle) * 3;
                        moon.position.z = Math.sin(moon.userData.angle) * 3;
                    }
                }
            });

            // å°è¡Œæ˜Ÿå¸¦è¿åŠ¨
            asteroids.forEach(asteroid => {
                const data = asteroid.userData;
                data.angle += data.speed * effectiveSpeed;
                asteroid.position.x = Math.cos(data.angle) * data.distance;
                asteroid.position.z = Math.sin(data.angle) * data.distance;
                asteroid.rotation.x += data.rotationSpeed * effectiveSpeed;
                asteroid.rotation.y += data.rotationSpeed * effectiveSpeed;
            });

            // å½—æ˜Ÿè¿åŠ¨ï¼ˆæ¤­åœ†è½¨é“ï¼‰
            comets.forEach(comet => {
                const data = comet.userData;
                data.angle += data.speed * effectiveSpeed;
                
                // æ¤­åœ†è½¨é“è®¡ç®—
                const a = (data.aphelion + data.perihelion) / 2; // åŠé•¿è½´
                const e = (data.aphelion - data.perihelion) / (data.aphelion + data.perihelion); // åå¿ƒç‡
                const r = a * (1 - e * e) / (1 + e * Math.cos(data.angle));
                
                comet.position.x = Math.cos(data.angle) * r;
                comet.position.z = Math.sin(data.angle) * r;
                
                // å½—å°¾å§‹ç»ˆèƒŒç¦»å¤ªé˜³
                const sunDirection = new THREE.Vector3(0, 0, 0).sub(comet.position).normalize();
                comet.children[0].lookAt(comet.position.clone().add(sunDirection));
            });

            // è·Ÿéšç›¸æœºæ¨¡å¼
            if (currentCameraMode === 'follow' && focusedPlanet) {
                const offset = new THREE.Vector3(10, 5, 10);
                camera.position.copy(focusedPlanet.position).add(offset);
                camera.lookAt(focusedPlanet.position);
            }

            // æ›´æ–°è½¨è¿¹
            updateTrails();

            // æ˜Ÿç©ºç¼“æ…¢æ—‹è½¬
            if (starField) {
                starField.rotation.y += 0.0002 * effectiveSpeed;
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            if (document.getElementById('statsPanel').classList.contains('visible')) {
                updateStats();
            }

            renderer.render(scene, camera);
        }

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html>
